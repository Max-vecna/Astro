<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Astro Chat V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --text-color: #e2e8f0;
            --text-muted-color: #94a3b8;
            --bubble-self-bg: #4f46e5;
            --bubble-other-bg: #334155;
            --app-height: 100vh;
        }

        [data-theme="light"] {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --background-color: #e2e8f0; /* Fundo off-white */
            --surface-color: #f8fafc;    /* Superf√≠cie um pouco mais clara */
            --text-color: #0f172a;
            --text-muted-color: #64748b;
            --bubble-self-bg: #6366f1;
            --bubble-other-bg: #ffffff; /* Bolha branca para contraste */
        }

        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: -10000px 5000px; }
        }
        body {
            font-family: 'SF Mono', 'Courier New', Courier, monospace;
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior: none;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            animation: stars 180s linear infinite;
            height: var(--app-height);
            transition: background-color 0.3s, color 0.3s;
        }
        .splash-loader {
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .chat-bubble {
            word-break: break-word;
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 20px; }
        .glassmorphism {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s, border-color 0.3s;
        }
        [data-theme="light"] .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .glow-on-hover:hover {
            box-shadow: 0 0 15px color-mix(in srgb, var(--primary-color) 60%, transparent);
        }

        .reactions-container {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }
        .reaction-chip {
            display: flex;
            align-items: center;
            background-color: color-mix(in srgb, var(--surface-color) 50%, transparent);
            border: 1px solid color-mix(in srgb, var(--primary-color) 30%, transparent);
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .reaction-chip.reacted {
             background-color: var(--primary-color);
             color: white;
             border-color: var(--primary-color);
        }
        .reaction-chip .reaction-count {
            font-weight: bold;
            margin-left: 4px;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .toast {
            background-color: rgba(15, 23, 42, 0.8);
            color: var(--text-color);
            padding: 10px 16px;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOutTop 4s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        @keyframes fadeInOutTop {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .notification-bubble {
            text-align: center;
            padding: 4px 12px;
            background-color: color-mix(in srgb, var(--surface-color) 50%, transparent);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: var(--text-muted-color);
            margin: 8px auto;
            max-width: fit-content;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .typing-indicator {
            padding: 4px 12px;
            font-size: 0.8rem;
            color: var(--text-muted-color);
            height: 24px;
            transition: opacity 0.3s;
        }

        #reply-preview {
            background-color: color-mix(in srgb, var(--background-color) 50%, transparent);
            border-left: 3px solid var(--primary-color);
            padding: 8px 12px;
            font-size: 0.8rem;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .message-actions-menu {
            position: absolute;
            z-index: 20;
            background-color: var(--surface-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            padding: 4px;
            min-width: 150px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.1s ease-out, transform 0.1s ease-out;
            pointer-events: none;
        }

        .message-actions-menu.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .message-actions-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .message-actions-menu-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .message-actions-menu-item i {
            width: 16px;
            text-align: center;
        }

        .replied-message-block {
            background-color: rgba(0,0,0,0.15);
            border-left: 2px solid var(--secondary-color);
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            opacity: 0.8;
            cursor: pointer;
        }

        [data-theme="light"] .replied-message-block {
            background-color: rgba(0,0,0,0.05);
        }
        
        .chat-bubble.is-consecutive {
            margin-top: 2px;
        }
        .items-start .chat-bubble.is-consecutive {
            border-top-left-radius: 8px;
        }
        .items-end .chat-bubble.is-consecutive {
            border-top-right-radius: 8px;
        }
        .items-start .chat-bubble.has-consecutive {
            border-bottom-left-radius: 8px;
        }
        .items-end .chat-bubble.has-consecutive {
            border-bottom-right-radius: 8px;
        }
        @keyframes static-flicker {
            0%, 100% { opacity: 0; }
            10% { opacity: 0.1; } 20% { opacity: 0.05; } 30% { opacity: 0.2; }
            40% { opacity: 0.1; } 50% { opacity: 0.25; } 60% { opacity: 0.15; }
            70% { opacity: 0.05; } 80% { opacity: 0.2; } 90% { opacity: 0.1; }
        }
        .static-effect::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI25vaXNlKSIvPjwvc3ZnPg==');
            background-size: cover;
            opacity: 0.3;
            animation: static-flicker 0.3s infinite;
            pointer-events: none;
        }

        .duel-invite-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 8px;
            font-weight: bold;
            display: inline-block;
            text-decoration: none;
            transition: transform 0.2s;
        }
        .duel-invite-button:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body data-theme="dark">
    
    <script>
        const setAppHeight = () => {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        };
        window.addEventListener('resize', setAppHeight);
        setAppHeight();
    </script>

    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 transition-opacity duration-500">
        <div class="flex items-center text-5xl font-bold text-slate-200 z-10">
            <i class="fas fa-rocket mr-3 transform -rotate-45 text-indigo-500"></i>
            <span>Astro</span>
        </div>
        <div class="splash-loader w-12 h-12 border-4 border-slate-700 rounded-full mt-12 z-10"></div>
        <p class="absolute bottom-10 text-slate-500 text-center px-4 z-10">Conectando gal√°xias, uma mensagem de cada vez.</p>
    </div>

    <div id="app-container" class="w-full h-full flex items-center justify-center opacity-0 transition-opacity duration-500" style="height: var(--app-height);">
        
        <div id="nickname-screen" class="w-full max-w-sm p-6 glassmorphism rounded-2xl shadow-lg flex-col gap-5 hidden sm:max-w-md md:max-w-lg">
             <h2 class="text-2xl font-bold text-center flex items-center justify-center gap-3"><i class="fas fa-user-astronaut text-indigo-400"></i>Identifica√ß√£o C√≥smica</h2>
            <div>
                <label for="nickname-input" class="text-sm font-medium text-muted-color">Crie seu apelido de viajante</label>
                <input type="text" id="nickname-input" placeholder="Viajante Estelar" class="w-full mt-1 p-3 bg-slate-900/80 border border-slate-700 rounded-md outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <button id="save-nickname-btn" class="w-full bg-[var(--primary-color)] hover:opacity-90 font-bold p-3 rounded-md transition-all glow-on-hover text-lg text-white">Entrar no Universo</button>
        </div>

        <div id="lobby-screen" class="w-full h-full max-w-md flex-col hidden relative sm:max-w-lg md:max-w-2xl bg-surface-color md:h-5/6 md:rounded-2xl">
             <header class="flex items-center justify-between p-4 glassmorphism md:rounded-t-2xl">
                <h2 class="text-xl font-bold">Conversas</h2>
                <div class="flex items-center gap-3">
                    <p class="text-sm">Ol√°, <span id="lobby-nickname" class="font-bold text-primary-color"></span>!</p>
                    <button id="change-nickname-btn" class="text-muted-color hover:text-text-color transition-colors"><i class="fas fa-edit"></i></button>
                </div>
            </header>
            <main id="room-list-container" class="flex-1 overflow-y-auto p-4 space-y-3 scroll-container"></main>

            <div class="absolute bottom-6 left-6">
                 <button id="settings-btn" class="w-14 h-14 bg-[var(--background-color)] hover:bg-surface-color/80 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 glow-on-hover transform hover:scale-110">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>

            <div id="new-conversation-container" class="absolute bottom-6 right-6">
                 <button id="new-conversation-btn" class="w-16 h-16 bg-[var(--secondary-color)] hover:opacity-90 rounded-full flex items-center justify-center shadow-lg transition-transform duration-300 glow-on-hover transform hover:scale-110">
                    <i class="fas fa-plus text-2xl text-white"></i>
                </button>
            </div>
        </div>

        <div id="chat-screen" class="w-full h-full flex-col hidden bg-surface-color/80 md:max-w-4xl md:h-5/6 md:rounded-2xl md:shadow-2xl">
            <header class="flex items-center justify-between p-4 glassmorphism md:rounded-t-2xl">
                <div class="flex items-center gap-4">
                    <button id="leave-btn" class="p-2 rounded-full hover:bg-black/10 text-xl transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div>
                        <div class="relative group cursor-pointer" id="room-code-wrapper">
                            <h2 class="font-bold text-lg text-primary-color flex items-center gap-2">
                                #<span class="room-code-value"></span>
                                <i class="fas fa-copy text-xs text-muted-color group-hover:text-primary-color transition-colors"></i>
                            </h2>
                            <span class="absolute top-full left-0 mt-2 px-3 py-1 bg-surface-color text-text-color text-xs rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10 shadow-lg">Copiar C√≥digo</span>
                            <span id="copy-feedback" class="absolute top-full left-0 mt-2 px-3 py-1 bg-green-500 text-white text-xs rounded-md opacity-0 transition-opacity duration-500 whitespace-nowrap hidden z-10">Copiado!</span>
                        </div>
                        <p id="user-count-display" class="text-xs text-green-400 font-medium"></p>
                    </div>
                </div>
                <div class="flex items-center -space-x-4" id="user-avatars-container"></div>
            </header>
            <main id="messages-container" class="flex-1 p-4 overflow-y-auto flex flex-col scroll-container">
                <div id="messages-list" class="flex flex-col gap-1">
                    <div id="typing-indicator-container" class="h-8"></div>
                </div>
            </main>
            <footer class="p-3 glassmorphism md:rounded-b-2xl">                
                <div id="reply-preview" class="hidden"></div>
                <div class="flex items-center gap-3">
                    <input type="text" id="message-input" placeholder="Digite uma mensagem..." class="flex-1 bg-[var(--background-color)] text-[var(--text-color)] rounded-full py-3 px-5 outline-none focus:ring-2 focus:ring-primary-color">
                    <button id="duel-btn" class="bg-[var(--secondary-color)] hover:opacity-90 w-12 h-12 rounded-full flex items-center justify-center transition-transform active:scale-90 glow-on-hover text-white">
                        <i class="fas fa-gamepad"></i>
                    </button>
                    <button id="send-btn" class="bg-[var(--primary-color)] hover:opacity-90 w-12 h-12 rounded-full flex items-center justify-center transition-transform active:scale-90 glow-on-hover text-white">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="duel-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full flex flex-col gap-4">
            <h3 class="text-xl font-bold text-center">Desafiar para Duelo</h3>
            <p class="text-sm text-center text-muted-color">Escolha um oponente online:</p>
            <div id="duel-user-list" class="space-y-2 max-h-60 overflow-y-auto scroll-container">
            </div>
            <button id="close-duel-modal-btn" class="w-full bg-slate-600 hover:bg-slate-700 p-3 rounded-md mt-2">Cancelar</button>
        </div>
    </div>
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full flex flex-col gap-5">
            <div class="flex justify-between items-center">
                 <h3 class="text-xl font-bold">Configura√ß√µes</h3>
                 <button id="close-settings-modal-btn" class="text-2xl text-muted-color hover:text-text-color">&times;</button>
            </div>
            <div>
                <label class="text-sm font-medium text-muted-color mb-2 block">Tema da Interface</label>
                <div class="flex gap-2">
                    <button data-theme="dark" class="theme-btn flex-1 p-3 rounded-lg border-2 border-transparent bg-slate-800 text-white">Astro (Escuro)</button>
                    <button data-theme="light" class="theme-btn flex-1 p-3 rounded-lg border-2 border-transparent bg-slate-200 text-black">Nebula (Claro)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="room-actions-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full flex flex-col gap-5">
            <div class="flex justify-between items-center">
                 <h3 class="text-xl font-bold">Nova Conversa</h3>
                 <button id="close-room-actions-modal-btn" class="text-2xl text-muted-color hover:text-text-color">&times;</button>
            </div>
            <button id="modal-create-room-btn" class="w-full bg-[var(--primary-color)] text-white hover:opacity-90 font-bold p-4 rounded-lg transition-all glow-on-hover flex items-center justify-center gap-3 text-lg"><i class="fas fa-meteor"></i>Criar Sala Privada</button>
            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-600"></div><span class="flex-shrink mx-4 text-muted-color text-sm">OU</span><div class="flex-grow border-t border-slate-600"></div></div>
            <div>
                 <label for="modal-room-code-input" class="text-sm font-medium text-muted-color mb-2 block">J√° tem um c√≥digo?</label>
                 <div class="flex gap-2">
                    <input type="text" id="modal-room-code-input" placeholder="C√ìDIGO" class="flex-1 p-3 bg-background-color border border-slate-700 rounded-md outline-none focus:ring-2 focus:ring-primary-color text-center uppercase tracking-widest font-bold">
                    <button id="modal-confirm-join-btn" class="bg-green-600 hover:bg-green-700 p-3 rounded-md font-bold aspect-square flex items-center justify-center transition-colors text-white"><i class="fas fa-arrow-right"></i></button>
                 </div>
            </div>
        </div>
    </div>
    <div id="confirm-reset-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full text-center flex flex-col gap-4">
            <div class="flex justify-between items-start">
                 <i class="fas fa-user-cog text-4xl text-yellow-400"></i>
                 <button id="cancel-reset-btn" class="text-2xl text-muted-color hover:text-text-color -mt-2 -mr-2">&times;</button>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-2">Op√ß√µes de Usu√°rio</h3>
                <p class="text-muted-color text-sm">O que voc√™ gostaria de fazer?</p>
            </div>
            <div class="flex flex-col gap-3 mt-2">
                <button id="confirm-change-nickname-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-bold rounded-lg py-3 px-6 transition-colors text-white">Alterar Apelido</button>
                <button id="confirm-delete-all-rooms-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold rounded-lg py-3 px-6 transition-colors text-white">Apagar Hist√≥rico de Salas</button>
            </div>
        </div>
    </div>
     <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full text-center">
            <i class="fas fa-trash-alt text-4xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Apagar Sala?</h3>
            <p class="text-muted-color mb-6">Esta a√ß√£o √© irrevers√≠vel e ir√° apagar a sala <strong id="delete-room-code" class="text-primary-color"></strong> para todos. Deseja continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-700 font-bold rounded-lg py-2 px-6 transition-colors text-white">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 font-bold rounded-lg py-2 px-6 transition-colors text-white">Sim, apagar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, onChildAdded, onChildChanged, serverTimestamp, onDisconnect, push, query, orderByKey, startAfter, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Cole aqui sua configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAxb2s4tzbtD1arG9UAf7UrzhFqbRrrsl8",
            authDomain: "astro-642b6.firebaseapp.com",
            databaseURL: "https://astro-642b6-default-rtdb.firebaseio.com",
            projectId: "astro-642b6",
            storageBucket: "astro-642b6.appspot.com",
            messagingSenderId: "141832763492",
            appId: "1:141832763492:web:c8f6a529849bab54ee8771"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentRoom, nickname, userId, presenceRef, typingTimeout, messageObserver;
        let roomUnsubscribes = [];
        let lobbyUnsubscribes = [];
        let notificationUnsubscribes = [];
        let roomToDelete = null;
        let replyingToMessage = null;
        let activeMessageMenu = null;
        const userColors = {};
        let onlineUsersInRoom = {};
        let isInitialPresenceLoad = true;

        const DOMElements = {
            splash: document.getElementById('splash-screen'),
            app: document.getElementById('app-container'),
            nicknameScreen: document.getElementById('nickname-screen'),
            lobbyScreen: document.getElementById('lobby-screen'),
            chat: document.getElementById('chat-screen'),
            nicknameInput: document.getElementById('nickname-input'),
            messagesContainer: document.getElementById('messages-container'),
            messagesList: document.getElementById('messages-list'),
            messageInput: document.getElementById('message-input'),
            typingIndicatorContainer: document.getElementById('typing-indicator-container'),
            replyPreview: document.getElementById('reply-preview'),
            roomCodeDisplay: document.querySelector('#chat-screen .room-code-value'),
            roomCodeWrapper: document.getElementById('room-code-wrapper'),
            copyFeedback: document.getElementById('copy-feedback'),
            userCountDisplay: document.getElementById('user-count-display'),
            userAvatarsContainer: document.getElementById('user-avatars-container'),
            roomListContainer: document.getElementById('room-list-container'),
            lobbyNickname: document.getElementById('lobby-nickname'),
            confirmResetModal: document.getElementById('confirm-reset-modal'),
            roomActionsModal: document.getElementById('room-actions-modal'),
            modalRoomCodeInput: document.getElementById('modal-room-code-input'),
            confirmDeleteModal: document.getElementById('confirm-delete-modal'),
            deleteRoomCode: document.getElementById('delete-room-code'),
            settingsModal: document.getElementById('settings-modal'),
            toastContainer: document.getElementById('toast-container'),
            duelBtn: document.getElementById('duel-btn'),
            duelModal: document.getElementById('duel-modal'),
            duelUserList: document.getElementById('duel-user-list'),
            closeDuelModalBtn: document.getElementById('close-duel-modal-btn'),
        };

        const EMOJI_LIST = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üôè'];

        // L√≥gica de Inicializa√ß√£o e Telas
        window.onload = async () => {
            initializeUser();
            initializeTheme();
            await new Promise(res => setTimeout(res, 2500));
            DOMElements.splash.style.opacity = 0;
            DOMElements.app.style.opacity = 1;
            setTimeout(() => DOMElements.splash.classList.add('hidden'), 500);

            nickname = localStorage.getItem('astroNickname');
            if (nickname) {
                DOMElements.nicknameInput.value = nickname;
                DOMElements.lobbyNickname.textContent = nickname;
                setupNotificationListeners();
                switchScreen('lobby');
            } else {
                switchScreen('nickname');
            }
        };

        const switchScreen = (screen) => {
            ['nickname', 'lobby', 'chat'].forEach(s => {
                const el = DOMElements[s === 'chat' ? 'chat' : `${s}Screen`];
                el.classList.toggle('hidden', s !== screen);
                el.classList.toggle('flex', s === screen);
            });
            clearLobbyListeners();
            if (screen === 'lobby') {
                if (Notification.permission === 'default') Notification.requestPermission();
                renderRoomList();
            } else if (screen === 'chat') {
                onlineUsersInRoom = {};
            }
        };
        
        // L√≥gica de Renderiza√ß√£o
        const renderMessage = (msgData, msgId) => {
            const existingMsgWrapper = DOMElements.messagesList.querySelector(`[data-msg-id="${msgId}"]`);
            if (existingMsgWrapper) {
                updateMessage(existingMsgWrapper, msgData);
                return;
            }

            const isSelf = msgData.userId === userId;
            const lastMessageWrapper = DOMElements.typingIndicatorContainer.previousElementSibling;
            const isConsecutive = lastMessageWrapper && lastMessageWrapper.dataset.userId === msgData.userId && msgData.type !== 'duel_invite';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex flex-col items-${isSelf ? 'end' : 'start'}`;
            messageWrapper.dataset.msgId = msgId;
            messageWrapper.dataset.userId = msgData.userId;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble relative group flex flex-col max-w-xs md:max-w-md lg:max-w-lg p-2 rounded-2xl`;
            bubble.style.backgroundColor = isSelf ? 'var(--bubble-self-bg)' : 'var(--bubble-other-bg)';
            bubble.style.color = isSelf ? '#fff' : 'var(--text-color)';
            
            if (isConsecutive) {
                bubble.classList.add('is-consecutive');
                const lastBubble = lastMessageWrapper.querySelector('.chat-bubble');
                if (lastBubble) lastBubble.classList.add('has-consecutive');
            }
            
            messageWrapper.appendChild(bubble);
            updateMessage(messageWrapper, msgData);
            
            DOMElements.messagesList.insertBefore(messageWrapper, DOMElements.typingIndicatorContainer);
            if(msgData.userId !== userId && !msgData.readBy?.[userId] && msgData.type !== 'duel_invite') {
                messageObserver.observe(messageWrapper);
            }
            DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
        };
        
        const renderNotification = (text) => {
            const notification = document.createElement('div');
            notification.className = 'notification-bubble';
            notification.textContent = text;
            DOMElements.messagesList.insertBefore(notification, DOMElements.typingIndicatorContainer);
            DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
        };

        const renderTypingIndicator = (typingUsers) => {
            const container = DOMElements.typingIndicatorContainer;
            container.innerHTML = '';
            
            Object.entries(typingUsers).forEach(([typingUserId, userData]) => {
                if (!userData || !userData.nickname) return;
                if (!userColors[typingUserId]) userColors[typingUserId] = `hsl(${Math.random() * 360}, 70%, 50%)`;
                
                const typingElement = document.createElement('div');
                typingElement.className = 'flex flex-col items-start';
                
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble relative flex flex-col max-w-xs p-2 mb-2 mt-2 rounded-2xl bg-[var(--bubble-other-bg)] opacity-60 static-effect';
                const sanitizedText = userData.text ? userData.text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '...';
                
                bubble.innerHTML = `
                    <span class="font-bold text-sm" style="color: ${userColors[typingUserId]};">${userData.nickname}</span>
                    <p class="text-[var(--text-color)] message-text">${sanitizedText}</p>
                `;
                
                typingElement.appendChild(bubble);
                container.appendChild(typingElement);
            });

            if (Object.keys(typingUsers).length > 0) {
                DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
            }
        };

        const updateMessage = (element, msgData) => {
            const bubble = element.querySelector('.chat-bubble');
            const msgId = element.dataset.msgId;
            if (!userColors[msgData.userId]) userColors[msgData.userId] = `hsl(${Math.random() * 360}, 70%, 50%)`;

            let contentHTML = '';

            if (msgData.type === 'duel_invite') {
                let duelHTML = `<p class="text-white message-text mt-1" style="color: inherit;">desafiou <strong>${msgData.challengedNickname}</strong> para um duelo!</p>`;
                
                switch (msgData.duelStatus) {
                    case 'accepted':
                        duelHTML += `<p class="font-bold text-green-400 mt-2">Duelo aceite! A preparar naves...</p>`;
                        break;
                    case 'refused':
                        duelHTML += `<p class="font-bold text-red-400 mt-2">Duelo recusado.</p>`;
                        break;
                    case 'pending':
                    default:
                        if (msgData.challengedId === userId) {
                            duelHTML += `
                                <div class="flex gap-2 mt-2">
                                    <button class="accept-duel-btn text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-full" data-msg-id="${msgId}" data-game-id="${msgData.duelGameId}">Aceitar</button>
                                    <button class="refuse-duel-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-full" data-msg-id="${msgId}">Recusar</button>
                                </div>`;
                        } else {
                            duelHTML += `<p class="text-sm text-muted-color mt-2">Aguardando resposta...</p>`;
                        }
                        break;
                }
                 contentHTML = `<div class="message-content">
                        <span class="font-bold text-sm" style="color: ${userColors[msgData.userId]};">${msgData.nickname}</span>
                        ${duelHTML}
                    </div>`;

            } else {
                const sanitizedText = msgData.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                let replyHTML = '';
                if (msgData.repliedTo) {
                   const repliedSanitizedText = msgData.repliedTo.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                   replyHTML = `<div class="replied-message-block" data-replied-id="${msgData.repliedTo.msgId}">
                           <strong class="font-bold">${msgData.repliedTo.nickname}</strong>
                           <p class="truncate opacity-80">${repliedSanitizedText}</p>
                       </div>`;
                }
                const showNickname = !element.classList.contains('is-consecutive') && msgData.userId !== userId;
                contentHTML = `${replyHTML}
                    <div class="message-content">
                        ${showNickname ? `<span class="font-bold text-sm" style="color: ${userColors[msgData.userId]};">${msgData.nickname}</span>` : ''}
                        <p class="text-white message-text ${showNickname ? '' : ''}" style="color: inherit;">${sanitizedText}</p>
                    </div>
                     <div class="message-actions-trigger cursor-pointer flex items-center self-end gap-2 text-xs opacity-70 hover:opacity-100 transition-opacity mt-1">
                        <span>${new Date(msgData.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        <span class="read-receipt-status">${msgData.userId === userId ? getReadReceiptIcon(msgData) : ''}</span>
                    </div>
                    <div class="reactions-container"></div>`;
            }

            bubble.innerHTML = contentHTML;

            const reactionsContainer = element.querySelector('.reactions-container');
            if (reactionsContainer && msgData.reactions) {
                reactionsContainer.innerHTML = '';
                Object.entries(msgData.reactions).forEach(([emoji, users]) => {
                    const userCount = Object.keys(users).length;
                    if (userCount > 0) {
                        const chip = document.createElement('div');
                        chip.className = 'reaction-chip';
                        if (users[userId]) chip.classList.add('reacted');
                        chip.dataset.emoji = emoji;
                        chip.innerHTML = `<span>${emoji}</span><span class="reaction-count">${userCount}</span>`;
                        reactionsContainer.appendChild(chip);
                    }
                });
            }
        };

        const openActionsMenu = (triggerElement, msgId, msgData) => {
            if (activeMessageMenu) activeMessageMenu.remove();
            
            const menu = document.createElement('div');
            menu.className = 'message-actions-menu';

            const reactionBar = document.createElement('div');
            reactionBar.className = 'flex justify-around p-1 mb-1 border-b border-white/10';
            EMOJI_LIST.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'p-1 text-lg hover:scale-125 transition-transform';
                btn.textContent = emoji;
                btn.onclick = () => {
                    toggleReaction(msgId, emoji);
                    if (activeMessageMenu) activeMessageMenu.remove();
                };
                reactionBar.appendChild(btn);
            });
            menu.appendChild(reactionBar);
            
            const isSelf = msgData.userId === userId;
            let itemsHTML = `
                <div class="message-actions-menu-item reply-btn"><i class="fas fa-reply"></i><span>Responder</span></div>
                <div class="message-actions-menu-item copy-btn"><i class="fas fa-copy"></i><span>Copiar</span></div>
            `;
            
            const itemsWrapper = document.createElement('div');
            itemsWrapper.innerHTML = itemsHTML;
            menu.appendChild(itemsWrapper);
            
            document.body.appendChild(menu);
            
            menu.querySelector('.reply-btn').onclick = () => handleReply(msgId, msgData);
            menu.querySelector('.copy-btn').onclick = () => {
                 navigator.clipboard.writeText(msgData.text);
                 showToast('Texto copiado!');
                 if (activeMessageMenu) activeMessageMenu.remove();
            };

            const rect = triggerElement.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();

            let top = rect.bottom + 4;
            let left = rect.left;

            if (left + menuRect.width > window.innerWidth) {
                left = window.innerWidth - menuRect.width - 4;
            }
            if (left < 0) {
                left = 4;
            }

            if (top + menuRect.height > window.innerHeight) {
                top = rect.top - menuRect.height - 4;
            }

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            
            setTimeout(() => menu.classList.add('active'), 10);
            activeMessageMenu = menu;
        };
        
        // Chat Logic (Firebase)
        const joinRoom = async (roomCode) => {
            await cleanupRoomListeners();
            if (!roomCode) return;
            const roomSnapshot = await get(ref(db, `rooms/${roomCode}`));
            if (!roomSnapshot.exists()) return showToast("Essa sala n√£o existe.", "leave");
            
            updateLastViewedTimestamp(roomCode);
            currentRoom = roomCode;
            updateRecentRooms(roomCode);
            setupNotificationListeners();

            switchScreen('chat');
            DOMElements.roomCodeDisplay.textContent = roomCode;
            DOMElements.messagesList.innerHTML = '';
            DOMElements.messagesList.appendChild(DOMElements.typingIndicatorContainer);
            
            isInitialPresenceLoad = true;

            initializePresence();
            initializeMessageObserver();
            
            const messagesRef = ref(db, `messages/${currentRoom}`);
            const unsubMessages = onChildAdded(query(messagesRef, orderByKey()), s => renderMessage(s.val(), s.key));
            const unsubMessageChanges = onChildChanged(query(messagesRef, orderByKey()), s => {
                const msgData = s.val();
                renderMessage(msgData, s.key);
                if (msgData.type === 'duel_invite' && msgData.duelStatus === 'accepted' && msgData.userId === userId) {
                    window.open(`./astro_duel.html?game=${msgData.duelGameId}`, '_blank');
                }
            });
            
            const unsubRoom = onValue(ref(db, `rooms/${currentRoom}`), s => !s.exists() && leaveRoom());
            const unsubPresence = onValue(ref(db, `presence/${currentRoom}`), updatePresenceUI);
            const unsubTyping = onValue(ref(db, `typing/${currentRoom}`), snapshot => {
                const typingUsers = snapshot.val() || {};
                delete typingUsers[userId];
                renderTypingIndicator(typingUsers);
            });
            
            roomUnsubscribes.push(unsubRoom, unsubPresence, unsubTyping, unsubMessages, unsubMessageChanges);
        };

        const sendMessage = () => {
            const text = DOMElements.messageInput.value.trim();
            if (!text || !currentRoom) return;
            const newMessage = {
                userId, nickname, text, 
                timestamp: serverTimestamp(),
                reactions: {},
                readBy: { [userId]: serverTimestamp() }
            };
            if(replyingToMessage) {
                newMessage.repliedTo = replyingToMessage;
            }
            set(push(ref(db, `messages/${currentRoom}`)), newMessage);
            DOMElements.messageInput.value = '';
            cancelReply();
            handleTyping();
        };

        const sendDuelInvite = (challengedId, challengedNickname) => {
            if (!currentRoom) return;
            const duelGameId = Math.random().toString(36).substring(2, 7).toUpperCase();
            
            const newMessage = {
                userId,
                nickname,
                type: 'duel_invite',
                duelStatus: 'pending',
                challengedId,
                challengedNickname,
                duelGameId,
                timestamp: serverTimestamp()
            };
            set(push(ref(db, `messages/${currentRoom}`)), newMessage);
            showToast(`Convite para duelo enviado para ${challengedNickname}!`);
        };

        const toggleReaction = (msgId, emoji) => {
            const reactionRef = ref(db, `messages/${currentRoom}/${msgId}/reactions/${emoji}/${userId}`);
            get(reactionRef).then(snapshot => {
                set(reactionRef, snapshot.exists() ? null : true);
            });
        };

        const markMessageAsRead = (msgId) => {
            const readRef = ref(db, `messages/${currentRoom}/${msgId}/readBy/${userId}`);
            set(readRef, serverTimestamp());
        };

        // UI Helpers & Events
        const getReadReceiptIcon = (msgData) => {
            const readByCount = msgData.readBy ? Object.keys(msgData.readBy).filter(id => id !== userId).length : 0;
            const onlineCount = Object.keys(onlineUsersInRoom).filter(id => id !== userId).length;

            if (readByCount >= onlineCount && onlineCount > 0) return `<i class="fas fa-check-double text-blue-400"></i>`;
            if (readByCount > 0) return `<i class="fas fa-check-double text-muted-color"></i>`;
            return `<i class="fas fa-check text-muted-color"></i>`;
        };
        
        const updatePresenceUI = (snapshot) => {
            const newOnlineUsers = snapshot.val() || {};
            
            if (isInitialPresenceLoad) {
                isInitialPresenceLoad = false;
            } else {
                Object.keys(newOnlineUsers).forEach(uid => {
                    const newUser = newOnlineUsers[uid];
                    const oldUser = onlineUsersInRoom[uid];
                    if (newUser.isOnline && (!oldUser || !oldUser.isOnline) && uid !== userId) {
                         renderNotification(`${newUser.nickname} entrou na sala.`);
                    }
                });

                Object.keys(onlineUsersInRoom).forEach(uid => {
                    const oldUser = onlineUsersInRoom[uid];
                    const newUser = newOnlineUsers[uid];
                    if (oldUser.isOnline && (!newUser || !newUser.isOnline)) {
                        renderNotification(`${oldUser.nickname} saiu da sala.`);
                    }
                });
            }
            
            onlineUsersInRoom = newOnlineUsers;

            const onlineUsersArray = Object.entries(onlineUsersInRoom).filter(([, u]) => u && u.isOnline);
            const onlineCount = onlineUsersArray.length;
            DOMElements.userCountDisplay.textContent = `${onlineCount} ${onlineCount !== 1 ? 'viajantes' : 'viajante'} online`;
            
            const avatarsContainer = DOMElements.userAvatarsContainer;
            avatarsContainer.innerHTML = ''; 
            onlineUsersArray.slice(0, 5).forEach(([id, user]) => {
                if (!user.nickname) return;
                if (!userColors[id]) userColors[id] = `hsl(${Math.random() * 360}, 70%, 50%)`;
                avatarsContainer.innerHTML += `<div title="${user.nickname}" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold border-2 border-[var(--surface-color)] shadow-lg transition-all duration-200 hover:scale-110 hover:z-10 hover:ring-2 hover:ring-offset-2 hover:ring-[var(--primary-color)] hover:ring-offset-[var(--surface-color)]" style="background-color: ${userColors[id]};">${user.nickname.charAt(0).toUpperCase()}</div>`;
            });
            if (onlineCount > 5) avatarsContainer.innerHTML += `<div title="${onlineCount - 5} mais" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold border-2 bg-slate-600 text-xs shadow-lg border-[var(--surface-color)]">+${onlineCount - 5}</div>`;
        };
        
        const handleTyping = () => {
            const typingRef = ref(db, `typing/${currentRoom}/${userId}`);
            const text = DOMElements.messageInput.value;
            if (text) {
                set(typingRef, { nickname, text });
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => set(typingRef, null), 3000);
            } else {
                set(typingRef, null);
            }
        };

        const initializePresence = () => {
            presenceRef = ref(db, `presence/${currentRoom}/${userId}`);
            set(presenceRef, { nickname, isOnline: true });
            onDisconnect(presenceRef).update({ isOnline: false, lastSeen: serverTimestamp() });
        };
        
        const initializeMessageObserver = () => {
            if(messageObserver) messageObserver.disconnect();
            messageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const msgId = entry.target.dataset.msgId;
                        markMessageAsRead(msgId);
                        messageObserver.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.8 });
        };

        const initializeUser = () => {
            let storedUserId = localStorage.getItem('astroUserId');
            if (!storedUserId || /[\.\#\$\[\]]/.test(storedUserId)) {
                storedUserId = `user_${Date.now()}_${Math.random().toString(36).substring(2)}`;
                localStorage.setItem('astroUserId', storedUserId);
            }
            userId = storedUserId;
        };
        
        const initializeTheme = () => {
            const savedTheme = localStorage.getItem('astroTheme') || 'dark';
            document.body.dataset.theme = savedTheme;
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.toggle('border-primary-color', btn.dataset.theme === savedTheme));
        };
        
        const renderRoomList = async () => {
            const list = DOMElements.roomListContainer;
            list.innerHTML = Array(3).fill('').map(() => `<div class="flex items-center p-3 bg-[var(--surface-color)] rounded-lg"><div class="w-10 h-10 rounded-full skeleton mr-3"></div><div class="flex-1 space-y-2"><div class="w-1/2 h-4 rounded skeleton"></div><div class="w-1/3 h-3 rounded skeleton"></div></div></div>`).join('');
            
            const createdRooms = new Set(JSON.parse(localStorage.getItem("createdRooms") || "[]"));
            const recentRooms = JSON.parse(localStorage.getItem("recentRooms") || "[]");
            const allRooms = [...new Set([...createdRooms, ...recentRooms])];

            if (allRooms.length === 0) {
                list.innerHTML = `<div class="text-center text-muted-color mt-10"><i class="fas fa-ghost text-5xl mb-4"></i><p>Nenhuma sala por aqui.</p><p class="text-sm">Crie uma ou entre com um c√≥digo!</p></div>`;
                return;
            }
            list.innerHTML = "";
            const lastViewedTimestamps = JSON.parse(localStorage.getItem('lastViewedTimestamps') || '{}');
            allRooms.forEach(roomCode => {
                const isCreator = createdRooms.has(roomCode);
                const roomElement = document.createElement('div');
                roomElement.className = "flex items-center p-3 bg-[var(--surface-color)] rounded-lg cursor-pointer hover:bg-primary-color/10 transition-colors";
                roomElement.dataset.roomcode = roomCode;
                roomElement.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            ${isCreator ? 
                            '<i class="fas fa-rocket text-yellow-400" title="Sala criada por voc√™"></i>' : 
                            '<i class="fas fa-satellite-dish text-cyan-400"></i>'
                            }
                            <span class="font-bold text-primary-color">${roomCode}</span>
                        </div>
                        <p class="text-sm text-muted-color mt-1 unread-badge">Sem novas mensagens...</p>
                    </div>
                    <div class="flex flex-col items-center justify-center gap-2">
                        <p class="text-sm text-muted-color mt-1 online-count text-green-400">...</p>
                        ${isCreator ? 
                        `<button class="btn-delete-room text-muted-color hover:text-red-500 p-2 rounded-md" title="Apagar sala para todos" data-roomcode="${roomCode}">
                            <i class="fas fa-trash pointer-events-none"></i>
                        </button>` : 
                        `<button class="btn-remove-room text-muted-color hover:text-yellow-500 p-2 rounded-md" title="Remover da sua lista" data-roomcode="${roomCode}">
                            <i class="fas fa-times-circle pointer-events-none"></i>
                        </button>`
                        }
                    </div>`;
                list.appendChild(roomElement);
                
                const unsubRoomDeletion = onValue(ref(db, `rooms/${roomCode}`), (snapshot) => {
                    if (!snapshot.exists()) {
                        roomElement.remove();
                        let created = JSON.parse(localStorage.getItem("createdRooms") || "[]").filter(r => r !== roomCode);
                        localStorage.setItem("createdRooms", JSON.stringify(created));
                        let recent = JSON.parse(localStorage.getItem("recentRooms") || "[]").filter(r => r !== roomCode);
                        localStorage.setItem("recentRooms", JSON.stringify(recent));
                        if (list.childElementCount === 0) list.innerHTML = `<div class="text-center text-muted-color mt-10"><i class="fas fa-ghost text-5xl mb-4"></i><p>Nenhuma sala por aqui.</p></div>`;
                    }
                });
                const unsubPresence = onValue(ref(db, `presence/${roomCode}`), s => {
                    const onlineCount = s.exists() ? Object.values(s.val()).filter(u => u.isOnline).length : 0;
                    const countEl = roomElement.querySelector('.online-count');
                    if(countEl) countEl.textContent = `${onlineCount} on`;
                });
                const unreadBadge = roomElement.querySelector('.unread-badge');
                const lastViewed = lastViewedTimestamps[roomCode] || 0;
                const unsubMessagesCount = onValue(query(ref(db, `messages/${roomCode}`)), (s) => {
                    if (!s.exists()) return;
                    let unreadCount = 0;
                    s.forEach(c => { if (c.val().timestamp > lastViewed && c.val().userId !== userId) unreadCount++; });
                    
                    if (unreadCount > 0)
                    { 
                        var txt = " mensagens n√£o lidas";
                        if(unreadCount == 1) { txt =" mensagem n√£o lida" }

                        unreadBadge.textContent = unreadCount > 9 ? '9+' : unreadCount + txt;
                        unreadBadge.classList.remove('opacity-0');
                    } else {
                        unreadBadge.textContent = "Sem novas mensagens...";
                    }
                });
                lobbyUnsubscribes.push(unsubRoomDeletion, unsubPresence, unsubMessagesCount);
            });
        };
        
        const handleReply = (msgId, msgData) => {
            replyingToMessage = { msgId, nickname: msgData.nickname, text: msgData.text };
            DOMElements.replyPreview.innerHTML = `
                <div class="flex-1">
                    <p class="font-bold text-sm">Respondendo a ${msgData.nickname}</p>
                    <p class="truncate text-muted-color">${msgData.text}</p>
                </div>
                <button id="cancel-reply-btn" class="p-2 text-muted-color hover:text-text-color"><i class="fas fa-times"></i></button>
            `;
            DOMElements.replyPreview.classList.remove('hidden');
            DOMElements.replyPreview.classList.add('flex', 'items-center', 'justify-between');
            DOMElements.messageInput.focus();
        };

        const cancelReply = () => {
            replyingToMessage = null;
            DOMElements.replyPreview.classList.add('hidden');
            DOMElements.replyPreview.classList.remove('flex', 'items-center', 'justify-between');
            DOMElements.replyPreview.innerHTML = '';
        };

        const openDuelModal = () => {
            const list = DOMElements.duelUserList;
            list.innerHTML = ''; 

            const onlineOpponents = Object.entries(onlineUsersInRoom)
                .filter(([id, user]) => id !== userId && user.isOnline);

            if (onlineOpponents.length === 0) {
                list.innerHTML = `<p class="text-center text-muted-color">Nenhum outro jogador online.</p>`;
            } else {
                onlineOpponents.forEach(([id, user]) => {
                    const userButton = document.createElement('button');
                    userButton.className = 'w-full text-left p-3 rounded-md hover:bg-primary-color/20 transition-colors';
                    userButton.textContent = user.nickname;
                    if (!userColors[id]) userColors[id] = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    userButton.style.borderLeft = `4px solid ${userColors[id]}`;

                    userButton.onclick = () => {
                        sendDuelInvite(id, user.nickname);
                        DOMElements.duelModal.classList.add('hidden');
                        DOMElements.duelModal.classList.remove('flex');
                    };
                    list.appendChild(userButton);
                });
            }

            DOMElements.duelModal.classList.remove('hidden');
            DOMElements.duelModal.classList.add('flex');
        };

        // Event Listeners
        document.body.addEventListener('click', (e) => {
            if (activeMessageMenu && !activeMessageMenu.contains(e.target)) {
                activeMessageMenu.remove();
                activeMessageMenu = null;
            }
            if(e.target.id === 'cancel-reply-btn' || e.target.closest('#cancel-reply-btn')) {
                cancelReply();
            }
        });

        DOMElements.messagesList.addEventListener('click', async e => {
            const acceptBtn = e.target.closest('.accept-duel-btn');
            if (acceptBtn) {
                e.preventDefault();
                const msgId = acceptBtn.dataset.msgId;
                const gameId = acceptBtn.dataset.gameId;
                const messageRef = ref(db, `messages/${currentRoom}/${msgId}`);
                update(messageRef, { duelStatus: 'accepted' });
                window.open(`./astro_duel.html?game=${gameId}`, '_blank');
                return;
            }

            const refuseBtn = e.target.closest('.refuse-duel-btn');
            if(refuseBtn) {
                const msgId = refuseBtn.dataset.msgId;
                const messageRef = ref(db, `messages/${currentRoom}/${msgId}`);
                update(messageRef, { duelStatus: 'refused' });
                return;
            }

            const reactionChip = e.target.closest('.reaction-chip');
            const replyBlock = e.target.closest('.replied-message-block');
            const actionsTrigger = e.target.closest('.message-actions-trigger');
            const msgWrapper = e.target.closest('[data-msg-id]');
            
            if (!msgWrapper) return;
            const msgId = msgWrapper.dataset.msgId;
            const msgSnapshot = await get(ref(db, `messages/${currentRoom}/${msgId}`));
            if (!msgSnapshot.exists()) return;
            const msgData = msgSnapshot.val();

            if (actionsTrigger && msgData.type !== 'duel_invite') {
                e.stopPropagation();
                openActionsMenu(actionsTrigger, msgId, msgData);
                return;
            }

            if (replyBlock) {
                const repliedId = replyBlock.dataset.repliedId;
                const originalMsgEl = DOMElements.messagesList.querySelector(`[data-msg-id="${repliedId}"]`);
                if (originalMsgEl) {
                    originalMsgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    originalMsgEl.querySelector('.chat-bubble').classList.add('animate-pulse');
                    setTimeout(() => originalMsgEl.querySelector('.chat-bubble').classList.remove('animate-pulse'), 1500);
                }
            }

            if (reactionChip) {
                toggleReaction(msgId, reactionChip.dataset.emoji);
            }
        });
        
        DOMElements.duelBtn.addEventListener('click', openDuelModal);
        DOMElements.closeDuelModalBtn.addEventListener('click', () => {
             DOMElements.duelModal.classList.add('hidden');
             DOMElements.duelModal.classList.remove('flex');
        });

        document.getElementById('settings-btn').addEventListener('click', () => {
            DOMElements.settingsModal.classList.remove('hidden');
            DOMElements.settingsModal.classList.add('flex');
        });
        document.getElementById('close-settings-modal-btn').addEventListener('click', () => {
            DOMElements.settingsModal.classList.add('hidden');
            DOMElements.settingsModal.classList.remove('flex');
        });

        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                document.body.dataset.theme = theme;
                localStorage.setItem('astroTheme', theme);
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('border-primary-color'));
                btn.classList.add('border-primary-color');
            });
        });

        const leaveRoom = async () => {
            if(currentRoom) updateLastViewedTimestamp(currentRoom);
            if(messageObserver) messageObserver.disconnect();
            await cleanupRoomListeners();
            currentRoom = null;
            switchScreen('lobby');
        };
        const cleanupRoomListeners = async () => {
            if (presenceRef) await set(ref(db, `presence/${currentRoom}/${userId}`), { isOnline: false });
            roomUnsubscribes.forEach(unsub => unsub());
            roomUnsubscribes = [];
            presenceRef = null;
        };
        const updateRecentRooms = (roomCode) => {
             let recentRooms = JSON.parse(localStorage.getItem("recentRooms") || "[]").filter(r => r !== roomCode);
            recentRooms.unshift(roomCode);
            localStorage.setItem("recentRooms", JSON.stringify(recentRooms.slice(0, 10)));
        };
         const updateLastViewedTimestamp = (roomCode) => {
            if (!roomCode) return;
            const timestamps = JSON.parse(localStorage.getItem('lastViewedTimestamps') || '{}');
            timestamps[roomCode] = Date.now();
            localStorage.setItem('lastViewedTimestamps', JSON.stringify(timestamps));
        };
        const createRoom = async () => {
            const roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
            await set(ref(db, `rooms/${roomCode}`), { createdAt: serverTimestamp() });
            let createdRooms = JSON.parse(localStorage.getItem("createdRooms") || "[]");
            createdRooms.unshift(roomCode);
            localStorage.setItem("createdRooms", JSON.stringify(createdRooms.slice(0, 10)));
            setupNotificationListeners();
            joinRoom(roomCode);
            await navigator.clipboard.writeText(roomCode);
            showToast(`Sala #${roomCode} criada e c√≥digo copiado!`);
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="${type === 'enter' ? 'fas fa-user-plus text-green-400' : type === 'leave' ? 'fas fa-user-minus text-red-400' : 'fas fa-info-circle text-indigo-400'}"></i> <span class="toast-message">${message}</span>`;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };
        const clearLobbyListeners = () => {
            lobbyUnsubscribes.forEach(unsub => unsub());
            lobbyUnsubscribes = [];
        };
        const saveNicknameAndEnterLobby = () => {
            nickname = DOMElements.nicknameInput.value.trim();
            if (!nickname) return;
            localStorage.setItem('astroNickname', nickname);
            DOMElements.lobbyNickname.textContent = nickname;
            setupNotificationListeners();
            switchScreen('lobby');
        };
        document.getElementById('save-nickname-btn').addEventListener('click', saveNicknameAndEnterLobby);
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('leave-btn').addEventListener('click', leaveRoom);
        
        DOMElements.roomListContainer.addEventListener('click', e => {
            const roomItem = e.target.closest('[data-roomcode]');
            if (!roomItem) return;

            const roomCode = roomItem.dataset.roomcode;
            const deleteBtn = e.target.closest('.btn-delete-room');
            const removeBtn = e.target.closest('.btn-remove-room');

            if (deleteBtn) {
                roomToDelete = roomCode;
                DOMElements.deleteRoomCode.textContent = roomToDelete;
                DOMElements.confirmDeleteModal.classList.remove('hidden');
                DOMElements.confirmDeleteModal.classList.add('flex');
            } else if (removeBtn) {
                let recentRooms = JSON.parse(localStorage.getItem("recentRooms") || "[]");
                recentRooms = recentRooms.filter(r => r !== roomCode);
                localStorage.setItem("recentRooms", JSON.stringify(recentRooms));
                
                roomItem.remove();
                showToast(`Sala #${roomCode} removida da sua lista.`);
                
                if (DOMElements.roomListContainer.childElementCount === 0) {
                    DOMElements.roomListContainer.innerHTML = `<div class="text-center text-muted-color mt-10"><i class="fas fa-ghost text-5xl mb-4"></i><p>Nenhuma sala por aqui.</p><p class="text-sm">Crie uma ou entre com um c√≥digo!</p></div>`;
                }
            } else {
                joinRoom(roomCode);
            }
        });

        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            DOMElements.confirmDeleteModal.classList.add('hidden');
            DOMElements.confirmDeleteModal.classList.remove('flex');
        });
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (roomToDelete) set(ref(db, `rooms/${roomToDelete}`), null);
            DOMElements.confirmDeleteModal.classList.add('hidden');
            DOMElements.confirmDeleteModal.classList.remove('flex');
            roomToDelete = null;
        });
        const closeActionsModal = () => {
            DOMElements.roomActionsModal.classList.add('hidden');
            DOMElements.roomActionsModal.classList.remove('flex');
        };
        document.getElementById('new-conversation-btn').addEventListener('click', () => {
            DOMElements.roomActionsModal.classList.remove('hidden');
            DOMElements.roomActionsModal.classList.add('flex');
        });
        document.getElementById('modal-create-room-btn').addEventListener('click', () => { createRoom(); closeActionsModal(); });
        document.getElementById('modal-confirm-join-btn').addEventListener('click', () => {
            const roomCode = DOMElements.modalRoomCodeInput.value.trim().toUpperCase();
            if (roomCode) { joinRoom(roomCode); closeActionsModal(); }
        });

        document.getElementById('change-nickname-btn').addEventListener('click', () => {
            DOMElements.confirmResetModal.classList.remove('hidden');
            DOMElements.confirmResetModal.classList.add('flex');
        });
        document.getElementById('cancel-reset-btn').addEventListener('click', () => {
            DOMElements.confirmResetModal.classList.add('hidden');
            DOMElements.confirmResetModal.classList.remove('flex');
        });
        document.getElementById('confirm-change-nickname-btn').addEventListener('click', () => {
            localStorage.removeItem('astroNickname');
            DOMElements.confirmResetModal.classList.add('hidden');
            DOMElements.confirmResetModal.classList.remove('flex');
            clearNotificationListeners();
            switchScreen('nickname');
        });
        document.getElementById('confirm-delete-all-rooms-btn').addEventListener('click', () => {
            localStorage.removeItem('createdRooms');
            localStorage.removeItem('recentRooms');
            localStorage.removeItem('lastViewedTimestamps');
            DOMElements.confirmResetModal.classList.add('hidden');
            DOMElements.confirmResetModal.classList.remove('flex');
            showToast('Hist√≥rico de salas foi apagado.');
            renderRoomList();
        });

        DOMElements.messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        DOMElements.messageInput.addEventListener('input', handleTyping);

        const clearNotificationListeners = () => {
            notificationUnsubscribes.forEach(unsub => unsub());
            notificationUnsubscribes = [];
        };
        const setupNotificationListeners = () => {
            clearNotificationListeners();
            const allRooms = [...new Set([...JSON.parse(localStorage.getItem("createdRooms")||"[]"), ...JSON.parse(localStorage.getItem("recentRooms")||"[]")])];
            allRooms.forEach(roomCode => {
                const messagesRef = ref(db, `messages/${roomCode}`);
                get(query(messagesRef, orderByKey())).then(initialSnapshot => {
                    let lastKey = null;
                    if (initialSnapshot.exists()) initialSnapshot.forEach(child => { lastKey = child.key; });
                    
                    const newMessagesQuery = lastKey ? query(messagesRef, orderByKey(), startAfter(lastKey)) : query(messagesRef, orderByKey());
                    const unsub = onChildAdded(newMessagesQuery, (s) => {
                        const msg = s.val();
                        if(msg && msg.userId !== userId && currentRoom !== roomCode && Notification.permission === 'granted' && !document.hasFocus()) {
                            const body = msg.type === 'duel_invite' ? `${msg.nickname} desafiou voc√™ para um duelo!` : `${msg.nickname}: ${msg.text}`;
                            new Notification(`Nova mensagem em #${roomCode}`, { body, icon: `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>`})
                            .onclick = () => { window.focus(); joinRoom(roomCode); };
                        }
                    });
                    notificationUnsubscribes.push(unsub);
                });
            });
        };
    </script>
</body>
</html>

