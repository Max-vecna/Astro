<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Astro Chat V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --secondary-color: #7c3aed; /* Violet-600 */
            --background-color: #0f172a; /* Slate-900 */
            --surface-color: #1e293b; /* Slate-800 */
            --text-color: #e2e8f0; /* Slate-200 */
            --text-muted-color: #94a3b8; /* Slate-400 */
            --app-height: 100vh; /* Fallback */
        }
        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: -10000px 5000px; }
        }
        body {
            font-family: 'SF Mono', 'Courier New', Courier, monospace;
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior: none;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            animation: stars 180s linear infinite;
            height: var(--app-height);
        }
        .splash-loader {
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .chat-bubble {
            word-break: break-word;
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 20px; }
        .glassmorphism {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glow-on-hover:hover {
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6);
        }
        
        @keyframes static-flicker {
            0%, 100% { opacity: 0; }
            10% { opacity: 0.1; } 20% { opacity: 0.05; } 30% { opacity: 0.2; }
            40% { opacity: 0.1; } 50% { opacity: 0.25; } 60% { opacity: 0.15; }
            70% { opacity: 0.05; } 80% { opacity: 0.2; } 90% { opacity: 0.1; }
        }

        .static-effect::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI25vaXNlKSIvPjwvc3ZnPg==');
            background-size: cover;
            opacity: 0.3;
            animation: static-flicker 0.3s infinite;
            pointer-events: none;
        }
        
        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        .skeleton {
            animation: shimmer 1.5s linear infinite;
            background: linear-gradient(to right, #2c3e50 8%, #46607e 18%, #2c3e50 33%);
            background-size: 800px 104px;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .toast {
            background-color: rgba(15, 23, 42, 0.8);
            color: var(--text-color);
            padding: 10px 16px;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOutTop 4s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .toast i { font-size: 1rem; }
        .toast .toast-message { font-weight: 500; }
        .toast .toast-nickname { font-weight: 700; }

        @keyframes fadeInOutTop {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="w-screen overflow-hidden">
    
    <script>
        // Corrige a altura da tela em dispositivos móveis para evitar cortes pela UI do navegador
        const setAppHeight = () => {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
        };
        window.addEventListener('resize', setAppHeight);
        setAppHeight(); // Define na carga inicial
    </script>

    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 transition-opacity duration-500">
        <div class="flex items-center text-5xl font-bold text-slate-200 z-10">
            <i class="fas fa-rocket mr-3 transform -rotate-45 text-indigo-500"></i>
            <span>Astro</span>
        </div>
        <div class="splash-loader w-12 h-12 border-4 border-slate-700 rounded-full mt-12 z-10"></div>
        <p class="absolute bottom-10 text-slate-500 text-center px-4 z-10">Conectando galáxias, uma mensagem de cada vez.</p>
    </div>

    <div id="app-container" class="w-full h-full flex items-center justify-center opacity-0 transition-opacity duration-500" style="height: var(--app-height);">
        
        <div id="nickname-screen" class="w-full max-w-sm p-6 glassmorphism rounded-2xl shadow-lg flex-col gap-5 hidden sm:max-w-md md:max-w-lg">
             <h2 class="text-2xl font-bold text-center text-slate-100 flex items-center justify-center gap-3"><i class="fas fa-user-astronaut text-indigo-400"></i>Identificação Cósmica</h2>
            <div>
                <label for="nickname-input" class="text-sm font-medium text-slate-400">Crie seu apelido de viajante</label>
                <input type="text" id="nickname-input" placeholder="Viajante Estelar" class="w-full mt-1 p-3 bg-slate-900/80 border border-slate-700 rounded-md outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <button id="save-nickname-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold p-3 rounded-md transition-colors glow-on-hover text-lg">Entrar no Universo</button>
        </div>

        <div id="lobby-screen" class="w-full h-full max-w-md flex-col hidden relative sm:max-w-lg md:max-w-2xl">
             <header class="flex items-center justify-between p-4 bg-slate-800/80 glassmorphism rounded-b-2xl">
                <h2 class="text-xl font-bold text-slate-100">Conversas</h2>
                <div class="flex items-center gap-2">
                    <p class="text-slate-300 text-sm">Olá, <span id="lobby-nickname" class="font-bold text-indigo-400"></span>!</p>
                    <button id="change-nickname-btn" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-edit"></i></button>
                </div>
            </header>
            <main id="room-list-container" class="flex-1 overflow-y-auto p-4 space-y-3 scroll-container"></main>

            <!-- Botão de Ação Principal Melhorado -->
            <div id="new-conversation-container" class="absolute bottom-6 right-6">
                 <button id="new-conversation-btn" class="w-16 h-16 bg-violet-600 hover:bg-violet-700 rounded-full flex items-center justify-center shadow-lg transition-transform duration-300 glow-on-hover transform hover:scale-110">
                    <i class="fas fa-plus text-2xl"></i>
                </button>
            </div>
        </div>

        <div id="chat-screen" class="w-full h-full flex-col hidden bg-slate-900/80 md:max-w-4xl md:h-5/6 md:rounded-2xl md:shadow-2xl">
            <header class="flex items-center justify-between p-3 bg-slate-800/80 shadow-md z-10 glassmorphism md:rounded-t-2xl">
                <button id="leave-btn" class="p-2 rounded-full hover:bg-slate-700 text-xl"><i class="fas fa-arrow-left"></i></button>
                <div class="flex-1 flex flex-col items-center">
                    <div class="relative group cursor-pointer" id="room-code-wrapper">
                        <h2 id="room-code-display" class="font-bold text-xl tracking-widest text-indigo-300 flex items-center gap-2">
                            <span class="room-code-value"></span>
                            <i class="fas fa-copy text-sm text-slate-400 group-hover:text-indigo-200 transition-colors"></i>
                        </h2>
                        <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1 bg-slate-700 text-slate-200 text-xs rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Copiar</span>
                        <span id="copy-feedback" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1 bg-green-500 text-white text-xs rounded-md opacity-0 transition-opacity duration-500 whitespace-nowrap hidden">Copiado!</span>
                    </div>
                    <p id="user-count-display" class="text-sm text-green-400 font-medium mt-1"></p>
                </div>
                <div class="w-8"></div>
            </header>
            <main id="messages-container" class="flex-1 p-4 overflow-y-auto flex flex-col scroll-container">
                <div id="messages-list" class="flex flex-col gap-1"></div>
            </main>
            <footer class="p-3 bg-slate-800/80 glassmorphism md:rounded-b-2xl">
                <div class="flex items-center gap-3">
                    <input type="text" id="message-input" placeholder="Digite uma mensagem..." class="flex-1 bg-slate-700 rounded-full py-3 px-5 outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="send-btn" class="bg-indigo-600 hover:bg-indigo-700 w-12 h-12 rounded-full flex items-center justify-center transition-transform active:scale-90 glow-on-hover">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Modal Unificado para Criar/Entrar em Salas -->
    <div id="room-actions-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full flex flex-col gap-5">
            <div class="flex justify-between items-center">
                 <h3 class="text-xl font-bold">Nova Conversa</h3>
                 <button id="close-room-actions-modal-btn" class="text-2xl text-slate-400 hover:text-white">&times;</button>
            </div>
           
            <button id="modal-create-room-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold p-4 rounded-lg transition-colors glow-on-hover flex items-center justify-center gap-3 text-lg">
                <i class="fas fa-meteor"></i>Criar Sala Privada
            </button>

            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-slate-600"></div>
                <span class="flex-shrink mx-4 text-slate-400 text-sm">OU</span>
                <div class="flex-grow border-t border-slate-600"></div>
            </div>

            <div>
                 <label for="modal-room-code-input" class="text-sm font-medium text-slate-400 mb-2 block">Já tem um código?</label>
                 <div class="flex gap-2">
                    <input type="text" id="modal-room-code-input" placeholder="CÓDIGO" class="flex-1 p-3 bg-slate-900/80 border border-slate-700 rounded-md outline-none focus:ring-2 focus:ring-indigo-500 text-center uppercase tracking-widest font-bold">
                    <button id="modal-confirm-join-btn" class="bg-green-600 hover:bg-green-700 p-3 rounded-md font-bold aspect-square flex items-center justify-center transition-colors">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                 </div>
            </div>
        </div>
    </div>

    <div id="confirm-reset-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Mudar de Apelido?</h3>
            <p class="text-slate-300 mb-6">Isso irá apagar seu histórico de salas criadas e recentes. Deseja continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-reset-btn" class="bg-slate-600 hover:bg-slate-700 font-bold rounded-lg py-2 px-6 transition-colors">Cancelar</button>
                <button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-700 font-bold rounded-lg py-2 px-6 transition-colors">Sim, apagar tudo</button>
            </div>
        </div>
    </div>

     <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-sm w-full text-center">
            <i class="fas fa-trash-alt text-4xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Apagar Sala?</h3>
            <p class="text-slate-300 mb-6">Esta ação é irreversível e irá apagar a sala <strong id="delete-room-code" class="text-indigo-300"></strong> para todos. Deseja continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-700 font-bold rounded-lg py-2 px-6 transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 font-bold rounded-lg py-2 px-6 transition-colors">Sim, apagar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, onChildAdded, serverTimestamp, onDisconnect, push, query, orderByKey, startAfter, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Cole aqui sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAxb2s4tzbtD1arG9UAf7UrzhFqbRrrsl8",
            authDomain: "astro-642b6.firebaseapp.com",
            databaseURL: "https://astro-642b6-default-rtdb.firebaseio.com",
            projectId: "astro-642b6",
            storageBucket: "astro-642b6.appspot.com",
            messagingSenderId: "141832763492",
            appId: "1:141832763492:web:c8f6a529849bab54ee8771"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentRoom, nickname, userId, presenceRef, typingTimeout;
        let roomUnsubscribes = [];
        let lobbyUnsubscribes = [];
        let notificationUnsubscribes = [];
        let roomToDelete = null;
        const userColors = {};
        let previousOnlineUsers = {};

        const DOMElements = {
            splash: document.getElementById('splash-screen'),
            app: document.getElementById('app-container'),
            nicknameScreen: document.getElementById('nickname-screen'),
            lobbyScreen: document.getElementById('lobby-screen'),
            chat: document.getElementById('chat-screen'),
            nicknameInput: document.getElementById('nickname-input'),
            messagesContainer: document.getElementById('messages-container'),
            messagesList: document.getElementById('messages-list'),
            messageInput: document.getElementById('message-input'),
            roomCodeDisplay: document.querySelector('#room-code-display .room-code-value'),
            roomCodeWrapper: document.getElementById('room-code-wrapper'),
            copyFeedback: document.getElementById('copy-feedback'),
            userCountDisplay: document.getElementById('user-count-display'),
            roomListContainer: document.getElementById('room-list-container'),
            lobbyNickname: document.getElementById('lobby-nickname'),
            confirmResetModal: document.getElementById('confirm-reset-modal'),
            roomActionsModal: document.getElementById('room-actions-modal'),
            modalRoomCodeInput: document.getElementById('modal-room-code-input'),
            confirmDeleteModal: document.getElementById('confirm-delete-modal'),
            deleteRoomCode: document.getElementById('delete-room-code'),
            toastContainer: document.getElementById('toast-container'),
        };

        window.onload = async () => {
            let storedUserId = localStorage.getItem('astroUserId');
            const invalidCharRegex = /[\.\#\$\[\]]/;
            if (storedUserId && invalidCharRegex.test(storedUserId)) {
                storedUserId = null;
                localStorage.removeItem('astroUserId');
            }
            userId = storedUserId || `user_${Date.now()}_${Math.random().toString(36).substring(2)}`;
            localStorage.setItem('astroUserId', userId);

            await new Promise(res => setTimeout(res, 2500));
            DOMElements.splash.style.opacity = 0;
            DOMElements.app.style.opacity = 1;
            setTimeout(() => DOMElements.splash.classList.add('hidden'), 500);

            nickname = localStorage.getItem('astroNickname');
            if (nickname) {
                DOMElements.nicknameInput.value = nickname;
                DOMElements.lobbyNickname.textContent = nickname;
                setupNotificationListeners();
                switchScreen('lobby');
            } else {
                switchScreen('nickname');
            }
        };
        
        const switchScreen = (screen) => {
            ['nickname', 'lobby', 'chat'].forEach(s => {
                const el = DOMElements[`${s}Screen`] || DOMElements[s];
                el.classList.toggle('hidden', s !== screen);
                el.classList.toggle('flex', s === screen);
            });
            clearLobbyListeners();
            if (screen === 'lobby') {
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                renderRoomList();
            } else if (screen === 'chat') {
                previousOnlineUsers = {};
            }
        };
        
        const saveNicknameAndEnterLobby = () => {
            nickname = DOMElements.nicknameInput.value.trim();
            if (!nickname) return;
            localStorage.setItem('astroNickname', nickname);
            DOMElements.lobbyNickname.textContent = nickname;
            setupNotificationListeners();
            switchScreen('lobby');
        };

        const renderMessage = (msgData) => {
            const allBubbles = DOMElements.messagesList.querySelectorAll('.chat-bubble[data-user-id]');
            const lastBubble = allBubbles.length > 0 ? allBubbles[allBubbles.length - 1] : null;
            const isConsecutive = lastBubble && lastBubble.dataset.userId === msgData.userId;
            const isSelf = msgData.userId === userId;

            if (isConsecutive && lastBubble) {
                const isSelfLast = lastBubble.classList.contains('self-end');
                lastBubble.classList.remove('rounded-bl-2xl', 'rounded-br-2xl', 'rounded-b-lg');
                lastBubble.classList.add(isSelfLast ? 'rounded-b-lg' : 'rounded-b-lg');
            }

            const messageElement = document.createElement('div');
            messageElement.dataset.userId = msgData.userId;
            
            let bubbleClasses = 'chat-bubble flex flex-col max-w-xs md:max-w-md lg:max-w-lg p-3 ';
            if (isSelf) {
                bubbleClasses += 'bg-indigo-600 self-end ';
                bubbleClasses += isConsecutive ? 'rounded-t-lg rounded-bl-lg' : 'rounded-t-2xl rounded-bl-2xl';
            } else {
                bubbleClasses += 'bg-slate-700 self-start ';
                bubbleClasses += isConsecutive ? 'rounded-t-lg rounded-br-lg' : 'rounded-t-2xl rounded-br-2xl';
            }
            messageElement.className = bubbleClasses;

            const sanitizedText = msgData.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const showNickname = !isSelf && !isConsecutive;

            if (!userColors[msgData.userId]) {
                userColors[msgData.userId] = `hsl(${Math.random() * 360}, 80%, 70%)`;
            }

            messageElement.innerHTML = `
                <span class="nickname-header font-bold text-sm ${showNickname ? '' : 'hidden'}" style="color: ${userColors[msgData.userId]};">
                    ${msgData.nickname}
                </span>
                <p class="text-white ${showNickname ? 'mt-1' : ''}">${sanitizedText}</p>
                <span class="text-xs text-slate-400 self-end mt-1">${new Date(msgData.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            `;
            
            const typingIndicators = DOMElements.messagesList.querySelector('.typing-indicator-container');
            DOMElements.messagesList.insertBefore(messageElement, typingIndicators);
            DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
        };
        
        const renderTypingIndicator = (typingUsers) => {
            let typingContainer = DOMElements.messagesList.querySelector('.typing-indicator-container');
            if(!typingContainer) {
                typingContainer = document.createElement('div');
                typingContainer.className = 'typing-indicator-container w-full';
                DOMElements.messagesList.appendChild(typingContainer);
            }
            typingContainer.innerHTML = '';
            
            Object.entries(typingUsers).forEach(([typingUserId, userData]) => {
                if (!userData || !userData.nickname) return;
                if (!userColors[typingUserId]) {
                    userColors[typingUserId] = `hsl(${Math.random() * 360}, 80%, 70%)`;
                }
                const userColor = userColors[typingUserId];
                const typingElement = document.createElement('div');
                typingElement.className = 'typing-bubble relative chat-bubble flex flex-col max-w-max p-3 rounded-t-2xl rounded-br-2xl bg-slate-700 self-start opacity-50 static-effect';
                const sanitizedText = userData.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                typingElement.innerHTML = `
                    <span class="font-bold text-sm" style="color: ${userColor};">${userData.nickname}</span>
                    <p class="text-white">${sanitizedText}</p>
                `;
                typingContainer.appendChild(typingElement);
            });
            if (Object.keys(typingUsers).length > 0) {
                DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
            }
        };
        
        const createRoom = async () => {
            const roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
            await set(ref(db, `rooms/${roomCode}`), { createdAt: serverTimestamp() });
            
            let createdRooms = JSON.parse(localStorage.getItem("createdRooms") || "[]");
            createdRooms.unshift(roomCode);
            localStorage.setItem("createdRooms", JSON.stringify(createdRooms.slice(0, 10)));
            
            setupNotificationListeners();
            joinRoom(roomCode);

            await navigator.clipboard.writeText(roomCode);
            showToast(`Sala #${roomCode} criada e código copiado!`);
        };

        const cleanupRoomListeners = async () => {
            if (presenceRef) {
                await set(presenceRef, { isOnline: false });
            }
            roomUnsubscribes.forEach(unsub => unsub());
            roomUnsubscribes = [];
            presenceRef = null;
        };

        const updateLastViewedTimestamp = (roomCode) => {
            if (!roomCode) return;
            const timestamps = JSON.parse(localStorage.getItem('lastViewedTimestamps') || '{}');
            timestamps[roomCode] = Date.now();
            localStorage.setItem('lastViewedTimestamps', JSON.stringify(timestamps));
        };

        const joinRoom = async (roomCode) => {
            await cleanupRoomListeners();
            
            if (!roomCode) return console.error("Código da sala inválido.");
            const roomSnapshot = await get(ref(db, `rooms/${roomCode}`));
            if (!roomSnapshot.exists()) {
                showToast("Essa sala não existe.", "leave");
                return;
            };
            
            updateLastViewedTimestamp(roomCode);
            
            currentRoom = roomCode;
            let recentRooms = JSON.parse(localStorage.getItem("recentRooms") || "[]");
            recentRooms = recentRooms.filter(r => r !== roomCode);
            recentRooms.unshift(roomCode);
            localStorage.setItem("recentRooms", JSON.stringify(recentRooms.slice(0, 10)));
            
            setupNotificationListeners();

            switchScreen('chat');
            DOMElements.roomCodeDisplay.textContent = roomCode;
            DOMElements.messagesList.innerHTML = '';
            
            presenceRef = ref(db, `presence/${currentRoom}/${userId}`);
            await set(presenceRef, { nickname, isOnline: true });
            onDisconnect(presenceRef).update({ isOnline: false, lastSeen: serverTimestamp() });

            const unsubRoom = onValue(ref(db, `rooms/${currentRoom}`), (snapshot) => {
                if (!snapshot.exists()) {
                    leaveRoom();
                }
            });
            roomUnsubscribes.push(unsubRoom);
            
            const unsubPresence = onValue(ref(db, `presence/${currentRoom}`), snapshot => {
                const currentUsers = snapshot.val() || {};
                const onlineUsersArray = Object.entries(currentUsers).filter(([id, u]) => u.isOnline);
                const onlineCount = onlineUsersArray.length;
                DOMElements.userCountDisplay.textContent = `${onlineCount} ${onlineCount > 1 ? 'viajantes' : 'viajante'} online`;

                if (Object.keys(previousOnlineUsers).length > 0) {
                    const currentOnlineIds = new Set(onlineUsersArray.map(([id, u]) => id));
                    const previousOnlineIds = new Set(Object.entries(previousOnlineUsers).filter(([id, u]) => u.isOnline).map(([id, u]) => id));
                    
                    currentOnlineIds.forEach(id => {
                        if (!previousOnlineIds.has(id) && id !== userId) {
                            showToast(`<span class="toast-nickname">${currentUsers[id].nickname}</span> entrou na sala`, 'enter');
                        }
                    });

                    previousOnlineIds.forEach(id => {
                        if (!currentOnlineIds.has(id) && id !== userId) {
                            showToast(`<span class="toast-nickname">${previousOnlineUsers[id].nickname}</span> saiu da sala`, 'leave');
                        }
                    });
                }
                previousOnlineUsers = currentUsers;
            });
            roomUnsubscribes.push(unsubPresence);

            const messagesRef = ref(db, `messages/${currentRoom}`);
            let lastKey = null;

            const initialMessagesSnapshot = await get(messagesRef);
            if (initialMessagesSnapshot.exists()) {
                const messages = [];
                initialMessagesSnapshot.forEach(child => {
                    messages.push({ ...child.val(), key: child.key });
                    lastKey = child.key;
                });
                messages.sort((a, b) => a.timestamp - b.timestamp);
                messages.forEach(msg => renderMessage(msg));
            }
            
            const newMessagesQuery = lastKey ? query(messagesRef, orderByKey(), startAfter(lastKey)) : messagesRef;
            const unsubMessages = onChildAdded(newMessagesQuery, (snapshot) => {
                 renderMessage({...snapshot.val(), key: snapshot.key});
            });
            roomUnsubscribes.push(unsubMessages);

            const unsubTyping = onValue(ref(db, `typing/${currentRoom}`), snapshot => {
                 const typingUsers = snapshot.val() || {};
                 delete typingUsers[userId];
                 renderTypingIndicator(typingUsers);
            });
            roomUnsubscribes.push(unsubTyping);
        };
        
        const sendMessage = () => {
            const text = DOMElements.messageInput.value.trim();
            if (text && currentRoom) {
                const newMessageRef = push(ref(db, `messages/${currentRoom}`));
                set(newMessageRef, { userId, nickname, text, timestamp: serverTimestamp() });
                DOMElements.messageInput.value = '';
                updateLastViewedTimestamp(currentRoom);
                handleTyping();
            }
        };

        const handleTyping = () => {
            const typingRef = ref(db, `typing/${currentRoom}/${userId}`);
            const text = DOMElements.messageInput.value;
            if (text) {
                set(typingRef, { nickname, text });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => set(typingRef, null), 3000);
            } else {
                set(typingRef, null);
            }
        };
        
        const leaveRoom = async () => {
            if(currentRoom) {
                updateLastViewedTimestamp(currentRoom);
            }
            await cleanupRoomListeners();
            currentRoom = null;
            switchScreen('lobby');
        };

        const renderRoomList = async () => {
            const list = DOMElements.roomListContainer;
            let skeletonHTML = '';
            for (let i = 0; i < 3; i++) {
                skeletonHTML += `
                    <div class="flex items-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="w-10 h-10 rounded-full skeleton mr-3"></div>
                        <div class="flex-1 space-y-2">
                            <div class="w-1/2 h-4 rounded skeleton"></div>
                            <div class="w-1/3 h-3 rounded skeleton"></div>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = skeletonHTML;

            const createdRooms = new Set(JSON.parse(localStorage.getItem("createdRooms") || "[]"));
            const recentRooms = JSON.parse(localStorage.getItem("recentRooms") || "[]");
            const allRooms = [...new Set([...createdRooms, ...recentRooms])];

            if (allRooms.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 mt-10">
                    <i class="fas fa-ghost text-5xl mb-4"></i>
                    <p>Nenhuma sala por aqui.</p>
                    <p class="text-sm">Crie uma ou entre com um código!</p>
                </div>`;
                return;
            }

            list.innerHTML = "";
            const lastViewedTimestamps = JSON.parse(localStorage.getItem('lastViewedTimestamps') || '{}');

            allRooms.forEach(roomCode => {
                const isCreator = createdRooms.has(roomCode);
                const roomElement = document.createElement('div');
                roomElement.className = "flex items-center p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-600/50 transition-colors";
                roomElement.dataset.roomcode = roomCode;
                roomElement.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            ${isCreator ? '<i class="fas fa-rocket text-yellow-400" title="Sala criada por você"></i>' : '<i class="fas fa-satellite-dish text-cyan-400"></i>'}
                            <span class="font-bold text-indigo-300">${roomCode}</span>
                        </div>
                         <p class="unread-badge text-sm text-slate-400 mt-1">0</p>
                    </div>
                    <div class="flex flex-col items-center justify-center gap-2">
                        <p class="text-sm mt-1 online-count text-green-400">...</p>
                        ${isCreator ? `<button class="btn-delete-room text-slate-500 hover:text-red-500 p-2 rounded-md" data-roomcode="${roomCode}"><i class="fas fa-trash pointer-events-none"></i></button>` : '<div class="w-10 h-10"></div>'}
                    </div>
                `;
                list.appendChild(roomElement);
                
                const unsubRoomDeletion = onValue(ref(db, `rooms/${roomCode}`), (snapshot) => {
                    if (!snapshot.exists()) {
                        const roomElToRemove = list.querySelector(`[data-roomcode="${roomCode}"]`);
                        if (roomElToRemove) roomElToRemove.remove();
                        
                        let created = JSON.parse(localStorage.getItem("createdRooms") || "[]");
                        localStorage.setItem("createdRooms", JSON.stringify(created.filter(r => r !== roomCode)));
                        let recent = JSON.parse(localStorage.getItem("recentRooms") || "[]");
                        localStorage.setItem("recentRooms", JSON.stringify(recent.filter(r => r !== roomCode)));

                        if (list.childElementCount === 0) {
                            list.innerHTML = `<div class="text-center text-slate-400 mt-10">
                                <i class="fas fa-ghost text-5xl mb-4"></i>
                                <p>Nenhuma sala por aqui.</p>
                                <p class="text-sm">Crie uma ou entre com um código!</p>
                            </div>`;
                        }
                    }
                });
                lobbyUnsubscribes.push(unsubRoomDeletion);

                const presenceRef = ref(db, `presence/${roomCode}`);
                const unsubPresence = onValue(presenceRef, (snapshot) => {
                    const onlineCount = snapshot.exists() ? Object.values(snapshot.val()).filter(u => u.isOnline).length : 0;
                    const countEl = roomElement.querySelector('.online-count');
                    if(countEl) countEl.textContent = `${onlineCount} on`;
                });
                lobbyUnsubscribes.push(unsubPresence);

                const unreadBadge = roomElement.querySelector('.unread-badge');
                const lastViewed = lastViewedTimestamps[roomCode] || 0;
                const messagesRef = ref(db, `messages/${roomCode}`);
                
                const unsubMessagesCount = onValue(query(messagesRef), (snapshot) => {
                    if (!snapshot.exists()) return;
                    let unreadCount = 0;
                    snapshot.forEach(child => {
                        const msg = child.val();
                        if (msg.timestamp > lastViewed && msg.userId !== userId) {
                            unreadCount++;
                        }
                    });
                    
                    if (unreadCount > 0)
                    { 
                        var txt = " mensagens não lidas";
                        if(unreadCount == 1) { txt =" mensagem não lida" }

                        unreadBadge.textContent = unreadCount > 9 ? '9+' : unreadCount + txt;
                        unreadBadge.classList.remove('opacity-0');
                    } else {
                        unreadBadge.classList.add('opacity-0');
                    }
                });
                lobbyUnsubscribes.push(unsubMessagesCount);
            });
        };

        const showNotification = (roomCode, text) => {
            if (Notification.permission !== 'granted' || document.hasFocus()) {
                return;
            }
            const notification = new Notification(`Nova mensagem em #${roomCode}`, {
                body: text,
                icon: `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>`
            });
            notification.onclick = () => {
                window.focus();
                joinRoom(roomCode);
            };
        };
        
        const clearNotificationListeners = () => {
            notificationUnsubscribes.forEach(unsub => unsub());
            notificationUnsubscribes = [];
        };
        
        const setupNotificationListeners = () => {
            clearNotificationListeners();
            const createdRooms = new Set(JSON.parse(localStorage.getItem("createdRooms") || "[]"));
            const recentRooms = JSON.parse(localStorage.getItem("recentRooms") || "[]");
            const allRooms = [...new Set([...createdRooms, ...recentRooms])];

            allRooms.forEach(roomCode => {
                let lastKey = null;
                const messagesRef = ref(db, `messages/${roomCode}`);
                get(query(messagesRef, orderByKey())).then(initialSnapshot => {
                    if (initialSnapshot.exists()) {
                        initialSnapshot.forEach(child => { lastKey = child.key; });
                    }
                    const newMessagesQuery = lastKey ? query(messagesRef, orderByKey(), startAfter(lastKey)) : messagesRef;
                    const unsub = onChildAdded(newMessagesQuery, (snapshot) => {
                        const msg = snapshot.val();
                        if(msg && msg.userId !== userId && currentRoom !== roomCode) {
                            showNotification(roomCode, `${msg.nickname}: ${msg.text}`);
                        }
                    });
                    notificationUnsubscribes.push(unsub);
                });
            });
        };

        const clearLobbyListeners = () => {
            lobbyUnsubscribes.forEach(unsub => unsub());
            lobbyUnsubscribes = [];
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            let iconClass = '';

            if (type === 'enter') iconClass = 'fas fa-user-plus text-green-400';
            else if (type === 'leave') iconClass = 'fas fa-user-minus text-red-400';
            else iconClass = 'fas fa-info-circle text-indigo-400';

            toast.className = 'toast';
            toast.innerHTML = `<i class="${iconClass}"></i> <span class="toast-message">${message}</span>`;
            DOMElements.toastContainer.appendChild(toast);

            setTimeout(() => toast.remove(), 4000);
        };
        
        // BIND DE EVENTOS
        document.getElementById('save-nickname-btn').addEventListener('click', saveNicknameAndEnterLobby);
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('leave-btn').addEventListener('click', leaveRoom);
        
        DOMElements.roomListContainer.addEventListener('click', e => {
             const roomItem = e.target.closest('[data-roomcode]');
             if(!roomItem) return;
             const roomCode = roomItem.dataset.roomcode;
             if(e.target.closest('.btn-delete-room')) {
                roomToDelete = roomCode;
                DOMElements.deleteRoomCode.textContent = roomCode;
                DOMElements.confirmDeleteModal.classList.remove('hidden');
                DOMElements.confirmDeleteModal.classList.add('flex');
             } else {
                 joinRoom(roomCode);
             }
        });
        
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            DOMElements.confirmDeleteModal.classList.add('hidden');
            DOMElements.confirmDeleteModal.classList.remove('flex');
            roomToDelete = null;
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (roomToDelete) {
                set(ref(db, `rooms/${roomToDelete}`), null);
                // A remoção da UI e do localStorage será tratada pelo listener onValue
            }
            DOMElements.confirmDeleteModal.classList.add('hidden');
            DOMElements.confirmDeleteModal.classList.remove('flex');
            roomToDelete = null;
        });

        const closeActionsModal = () => {
            DOMElements.roomActionsModal.classList.add('hidden');
            DOMElements.roomActionsModal.classList.remove('flex');
            DOMElements.modalRoomCodeInput.value = '';
        };
        
        document.getElementById('new-conversation-btn').addEventListener('click', () => {
            DOMElements.roomActionsModal.classList.remove('hidden');
            DOMElements.roomActionsModal.classList.add('flex');
        });

        document.getElementById('close-room-actions-modal-btn').addEventListener('click', closeActionsModal);
        document.getElementById('modal-create-room-btn').addEventListener('click', () => {
            createRoom();
            closeActionsModal();
        });
        document.getElementById('modal-confirm-join-btn').addEventListener('click', () => {
            const roomCode = DOMElements.modalRoomCodeInput.value.trim().toUpperCase();
            if (roomCode) {
                 joinRoom(roomCode);
                 closeActionsModal();
            }
        });

        document.getElementById('change-nickname-btn').addEventListener('click', () => {
            DOMElements.confirmResetModal.classList.remove('hidden');
            DOMElements.confirmResetModal.classList.add('flex');
        });
        document.getElementById('cancel-reset-btn').addEventListener('click', () => {
            DOMElements.confirmResetModal.classList.add('hidden');
            DOMElements.confirmResetModal.classList.remove('flex');
        });
        document.getElementById('confirm-reset-btn').addEventListener('click', () => {
            localStorage.removeItem('astroNickname');
            localStorage.removeItem('createdRooms');
            localStorage.removeItem('recentRooms');
            localStorage.removeItem('lastViewedTimestamps');
            DOMElements.confirmResetModal.classList.add('hidden');
            clearNotificationListeners();
            switchScreen('nickname');
        });

        DOMElements.messageInput.addEventListener('keydown', e => e.key === 'Enter' && sendMessage());
        DOMElements.messageInput.addEventListener('input', handleTyping);

        DOMElements.roomCodeWrapper.addEventListener('click', async () => {
            if (currentRoom) {
                await navigator.clipboard.writeText(currentRoom);
                DOMElements.copyFeedback.classList.remove('hidden', 'opacity-0');
                DOMElements.copyFeedback.classList.add('opacity-100');
                setTimeout(() => {
                    DOMElements.copyFeedback.classList.remove('opacity-100');
                    DOMElements.copyFeedback.classList.add('opacity-0');
                    setTimeout(() => DOMElements.copyFeedback.classList.add('hidden'), 500);
                }, 1500);
            }
        });
    </script>
</body>
</html>

